
@{
    ViewBag.Title = "New Sale";
}
<link href="~/Content/UI/indexes.css" rel="stylesheet" />
<h2>@ViewBag.Title</h2>
<div class="root cart">
    <div class="cart-action">
        <table class="table table-striped table-responsive">
            <thead class="bg-secondary text-white-50" style="text-align:center; background-color:dimgray;">

            </thead>
            <tbody>
                <tr>
                    <td style="padding:10px;" class="field ui left icon input">
                        <input class="form-control  rounded" type="date" id="getSaledate" name="SaleDate" />
                    </td>

                    <td style="padding:10px;" class="field ui left icon input">
                        @Html.DropDownList("Customer Type", new SelectList(@ViewBag.CusTypes, "Value", "Text"), "--Choose Customer Type--", new { @class = "ui dropdown", @id = "CustomerTypeId" })
                    </td>
                    <td style="padding:10px;" class="field ui left icon input">
                        <input class="form-control rounded form-control" type="text" id="getCustomer" name="Customer"
                               placeholder="CUSTOMER" />
                    </td>
                </tr>

                <tr>
                    <td style="padding:10px;" class="field ui left icon input">
                        <input class="form-control  rounded" type="text" id="getItemname" name="ItemName"
                               placeholder="ITEM NAME" autocomplete="on" />

                        <input class="form-control rounded" type="text" id="itemId" name="ItemID" hidden />
                    </td>

                    <td style="padding:10px;" class="field ui left icon input">
                        @Html.DropDownList("Units", new SelectList(@ViewBag.Units, "Value", "Text"), "--Choose Units--", new { @class = "ui dropdown", @id = "UnitId", @onchange = "getUnitName(this.value)" })
                    </td>
                    <td style="padding:10px;" class="field ui left icon input">
                        @Html.DropDownList("SaleType", new SelectList(@ViewBag.saleTypes, "Value", "Text"), "--Select Price Type--", new { @class = "ui dropdown", @id = "priceTypeId", @onchange = "getSalePrice(this.value)" })
                    </td>

                </tr>

                <tr>
                    <td style="padding:10px;" class="field ui left icon input">
                        <input class="form-control rounded form-control" type="text" id="getPrice" name="GetPrice"
                               placeholder="AMOUNT" />
                    </td>

                    <td style="padding:10px;" class="field ui left icon input">
                        <input class="form-control rounded form-control input-sm NumbersOnly"
                               type="text" id="getQtyRequested" name="QtyRqstd" placeholder="QUANTITY" oninput="getAmountTotal(this.value);" />
                    </td>

                    <td style="padding:10px;" class="field ui left icon input">
                        <input class="form-control rounded form-control" type="text" id="getAmontpaid" name="GetAmountPaid"
                               placeholder="AMOUNT PAID" />

                    </td>
                </tr>
                <tr>
                    <td style="padding:10px;" class="field ui left icon input">

                        @Html.DropDownList("Locations", new SelectList(@ViewBag.locations, "Value", "Text"), "--Choose Location--", new { @class = "ui dropdown", @id = "LocationId" })

                        <input class="form-control rounded form-control input-sm NumbersOnly"
                               type="hidden" id="getUnitname" name="UnitName" />
                    </td>

                    <td style="padding:10px;" class="field ui left icon input">
                        <input class="form-control rounded form-control" type="text" disabled id="getAmonttotal" name="GetAmountTotal"
                               placeholder="AMOUNT TOTAL" />
                    </td>
                    <td style="padding:10px;" class="field ui left icon input">
                        <input type="submit" value="ADD" class="ui button primary" id="addToCartBtn" />
                    </td>
                </tr>

            </tbody>
        </table>

        <hr />

        @using (Html.BeginForm("NewSale", "Sales", FormMethod.Post, new { @class = "ui form root", role = "form" }))
        {

            @Html.AntiForgeryToken()

            <div>
                <table class="table table-striped table-hover" style="min-width:100%">
                    <thead class="bg-dark text-white">
                        <tr>
                            <th>ITEM NAME</th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th>QUANTITY</th>
                            <th>AMOUNT</th>
                            <th>UNIT</th>
                            <th>AMOUNT PAID</th>

                            <th>
                                DELETE
                                @*<span><i class="trash icon"></i></span>*@
                            </th>
                        </tr>
                    </thead>
                    <tbody id="cartItemsTable"></tbody>
                </table>
            </div>

            <div>
                <input type="submit" value="SAVE" class="ui button success" id="createNoteBtn" />
            </div>
        }
    </div>
</div>

<style>
    th, td {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    /*#cartItemsTable{
        display:flex;
        align-content:flex-start;
        justify-content:space-between
    }*/
</style>

<script>
    $(document).ready(() => {
        //Get Item
        $("#getItemname").autocomplete({

            source: function (request, response) {
               var url =  "@Url.Action("GetItemName","Inventory")";
                /*
                 request = searches for the "getItemname's" value from GetSourceList action method.
                 response = returns the response from the GetSourceList method.
                 */
                $.ajax({
                url: url, type: "GET", dataType: "json", cache: false, contentType: "application/json; charset=utf-8",
                    data: { getItemname: request.term },

                    success: function (data) {
                         response($.map(data, function (item) {

                        return {label: item.label, value: item.value };
                         }));



                    }

                })

            },

            select: function (event, ui) {
            event.preventDefault();

                var urldetails = "@Url.Action("GetItemDetails","Inventory")";

            $.ajax({
                cache: false, async: false, type: "GET",
                url: urldetails,
                 data: { getItemname: ui.item.value },
                success: function (data) {
                    var item = data;

                    $("#getItemname").val(item.Item_Name);
                    $("#getItemId").val(item.Id);
                },
                error: function (request, ajaxOptions, thrownError) {
                   alert('Failed to retrieve Item.');
                }
            });
            }


        });//End of Auto complete

        //Get Customers

        $("#getCustomer").autocomplete({

            source: function (request, response) {
               // debugger
                var customerTypeId = $("#CustomerTypeId").val();

               @*//var url =  "@Url.Action("GetVendor","Inventory")";*@


                var url = "/Inventory/GetCustomer/" + customerTypeId;

               @*var url =  "@Url.Action("GetCustomer","Inventory")";*@

                $.ajax({
                url: url, type: "GET", dataType: "json", cache: false, contentType: "application/json; charset=utf-8",
                    data: { getCustomer: request.term },

                    success: function (data) {
                         response($.map(data, function (customer) {
                            return {label: customer, value: customer };
                         }));
                    }

                })

            },

            select: function (event, ui) {
            event.preventDefault();

                var urldetails = "@Url.Action("GetCustomerDetails","Inventory")";

            $.ajax({
                cache: false, async: false, type: "GET",
                url: urldetails,
                 data: { getCustomer: ui.item.value },
                success: function (data) {
                    var customer = data;
                    //debugger
                    $("#getCustomer").val(customer);


                },
                error: function (request, ajaxOptions, thrownError) {
                   alert('Failed to retrieve Item.');
                }
            });
            }


        });
        //End Customer Auto-complete



        //Add To Cart Function
        $('#addToCartBtn').on('click',function () {
                //check for Quantity requested
                    if ($('#getQtyRequested').val() == ''  || $('#getQtyRequested').val() == 0 || !$.isNumeric($('#getQtyRequested').val())) {
                        alert("Quantity cannot be empty!.");
            }

                //check for duplication
                if (CheckStockDuplication($('#getItemname').val())) {
                    alert("Record already exists, quantity requested will increase with the new quantity!.")
                    //alert("Redundant Record", 'This Stock has already been added. If you want to re-enter, please remove it form the list first!', "error");
                }
                else {
                    var $cartTable = $('#cartItemsTable');

                    var quant = Number($('#getQtyRequested').val());
                    var prc = parseFloat($('#getPrice').val());
                    var totalPrc_ = quant * prc;

                    var salesDate = $('#getSaledate').val();

                    var unitName = $('#getUnitname').val();
                    var unitId = $('#UnitId').val();

                    var amtPaid = $("#getAmontpaid").val();

                    var itemid = $("#itemId").val();

                    var locationId = $("#LocationId").val();

                     //debugger

                    $cartTable.append(
                        '<tr class="dynamicRows" id="hiddenRows">' +
                            '<td><input type="hidden" name="ItemName" class = "getItemName"    value="' + $('#getItemname').val() + '"/>' + $('#getItemname').val() + '</td>' +
                            '<td><input type="hidden" name="SaleDate" class = "getSalesDate"  value="' + salesDate + '"/>' + "" + '</td>' +
                            '<td><input type="hidden" name="CustomerTypeId" class = "geCustomerTypeId"  value="' + $('#CustomerTypeId').val() + '"/>' + "" + '</td>' +
                            '<td><input type="hidden" name="UnitId" class = "getUnitId"  value="' + unitId + '"/>' + "" + '</td>' +
                            '<td><input type="hidden" name="ItemCustomer" class = "getItemCustomer"      value="' + $('#getCustomer').val() + '"/>' + "" + '</td>' +
                            '<td><input type="hidden" name="QtyRqstd" class = "getQtyRequested"     value="' + $('#getQtyRequested').val() + '"  style="width:60px;"/>' + $('#getQtyRequested').val() + '</td>' +
                            '<td><input type="hidden" name="ItemPrice" class = "getItemprice"      value="' + totalPrc_ + '"/>' + totalPrc_ + '</td>' +
                            '<td><input type="hidden" name="ItemUnit" class = "getUnitName"      value="' + unitName + '"/>' + unitName + '</td>' +
                            '<td><input type="hidden" name="AmountPaid" class = "getAmountPaid"      value="' + amtPaid + '"/>' + amtPaid + '</td>' +
                            '<td><input type="hidden" name="ItemId" class = "getItemId"      value="' + itemid + '"/>' + "" + '</td>' +
                            '<td><input type="hidden" name="LocationId" class = "getLocationId"      value="' + locationId + '"/>' + "" + '</td>' +

                            //Delete icon
                            '<td><a style="color:red;" onClick="removeItem(this)"><span><i class="trash icon"></i></span></a></td>'
                        + '</tr>'
                    );

                    //cleans form
                    $(function () {
                        $clear = '';
                        //$('#getCustomer').val('');
                        $('#getItemname').val('');
                        $('#getPrice').val('');
                        $('#getQtyRequested').val('');
                        $('#getItemId').val('');
                        $('#getUnitname').val('');
                        $('#UnitId').val('');
                        $("#getAmontpaid").val('');//
                        $("#getAmonttotal").val('');//
                    });

                    return false;

                }

            })
        //Add To Cart END

        //Remove Item
        //removes record on clicking remove icon
        $(function removeItem() {
               // $(obj).parent().parent().remove();
              $(this).closest('tr .dynamicRows').remove();
                //$(this).closest('tr').remove();
        });
        //Remove Item END

        //Check for Duplicates
         function CheckStockDuplication(itemName) {
            var flag = false;

            $('.dynamicRows').each(function () {
                if ($(this).find('.getItemName').val() == itemName) {

                    var quant = Number($('#getQtyRequested').val());
                    var prc = parseFloat($('#getPrice').val());

                    var totalPrc = 0;

                    var oldquant = Number($(this).find('td:eq(1) input:hidden').val());
                    var oldprc = parseFloat($(this).find('td:eq(2) input:hidden').val());

                    var newquant = quant + oldquant;

                    var newprc = prc + oldprc;


                    totalPrc = prc * newquant;
                    //var totalPrc = newprc * newquant;


                    // $(this).find('td:eq(11) input:hidden').val(newquant);
                    //$(this).find('.txtqty').text(newquant);

                    var inputstring = $('<input type="hidden" name="QtyRqstd" class="getQtyRequested" value="' + newquant + '" style="width:60px;"/>');

                    var prcstring = $('<input type="hidden" name="Itemprice" class="getItemprice" value="' + totalPrc + '" style="width:60px;"/>');

                    var textvalue = newquant;


                    $(this).find('td:eq(1)').text("");

                    $(this).find('td:eq(1)').append(inputstring);

                    $(this).find('td:eq(1)').append(textvalue);

                    //Price

                     var pricvalue = totalPrc;


                    $(this).find('td:eq(2)').text("");

                    $(this).find('td:eq(2)').append(prcstring);

                    $(this).find('td:eq(2)').append(pricvalue);


                    flag = true;


                    $('#getQtyRequested').val('');
                     $('#getPrice').val('');
                    $('#getItemname').val('');

                }
            });//End of duplication check
            return flag;
        };
        //Check for Duplicates END


    })//End of Document function

    function getSalePrice(id) {


        var url_ = "/Sales/GetSalePrice/" + id;
        var itemName = $("#getItemname").val();

        if (itemName == null) {
            alert("Item Cannot be Empty!.");
        }
        $.ajax({
            url: url_,
            data: {
                id: id,
                item:itemName
            },
            dataType: "json",
            type: "GET",
            error: () => {
                getUnitName(id);

                alert("Cannot get the price for this item.!");
            },
            success: (data) => {
                $("#getPrice").val(data.itemAmout);
                $("#itemId").val(data.itemId_);

            }

        });
        }

    function getAmountTotal(qty) {
        var qty_ = Number(qty);
        var amount =parseFloat($("#getPrice").val());

        var amountTotal = qty_ * amount;

        $("#getAmonttotal").val(amountTotal);
        //debugger

        }

    function getUnitName(id) {
        var link = "/Sales/GetUnitName/" + id;

        $.ajax({
            url: link,
            dataType: "json",
            data: {
                id:id
            },
            type: "GET",
            error: () => {
                alert("Unit not set!.")
            },
            success: (data) => {
                $("#getUnitname").val(data.unitName);
                 //Append to Price Type Dropwon
                 if (data.priceTypes.length > 0) {
                      $('#priceTypeId').html('');
                     var options = '';
                     options += '<option value="Selecet">Select</option>';
                     for (var i = 0; i < data.priceTypes.length; i++) {
                         options += '<option value="' + data.priceTypes[i].Id + '">' + data.priceTypes[i].Name + '</option>';
                     }

                    $("#priceTypeId").append(options);
                 }

            }
        });
    }

</script>



